To test the described method for inferring functional connectivity from calcium imaging data, we simulated a network of stochastically connected neurons constructed as close as possible to resemble the real cortical micro-circuits, based on experimental data available from the literature \cite{Braitenberg1998, Urquijo2000, Lefort2009, Sayer1990}.  We prepared networks of $N=10-500$ neurons sparsely randomly connected to each other. Each neuron was modeled using GLM Eq.\eqref{eqn:glm:definition}).

The network was divided into excitatory and inhibitory components with 20\% of inhibitory neurons \cite{Braitenberg1998, Urquijo2000}.  Neurons in each component were either entirely excitatory or inhibitory, respecting Dale's law. I.e., all connections outgoing from each neuron were either all positive (excitatory) or all negative (inhibitory). Neurons were randomly connected to each other with probability $f_c=0.1$ \cite{Braitenberg1998, Lefort2009}.  Synaptic weights for excitatory connections, as defined by EPSP peak amplitude, were randomly drawn from exponential distribution with the mean of $0.5 \mu V$ \cite{Lefort2009, Sayer1990}. These were then converted to GLM weights: while synaptic weights physiologically were measured in $\mu V$, in GLM functional connectivity weights were measured in log-rate units of Eq.\eqref{eqn:glm:definition}). GLM weights described the change in the probability of the neuron $i$ to fire given neuron $j$ had fired before, as opposed to physiologically measured injected currents or changes in membrane potential. By utilizing this definition, synaptic weights were converted into GLM weights assuming that each EPSP corresponded to added probability of neuron spiking in given time bin of $\Delta P = v_{E}/V_{b}$, where $v_E$ is peak EPSP amplitude and $V_b$ is the membrane resting potential below threshold (implying that $V_{b}/v_{E}$ EPSPs would be required to trigger neuron over the threshold), 

\begin{equation}\label{eqn:convert}
w_{ij}=\ln(-\ln(e^{-r_i\tau_w}-v_{E}/V_{b})/r_i\tau_w), 
\end{equation}

where $r_i=\exp(b^i_0)$ was the base firing rate of neuron $i$ and $\tau_w=10$ ms was the typical EPSP/IPSP scale over which single EPSP affects the firing probability of the neuron $i$.  For small $r_i\tau_w$ this could be replaced with

\begin{equation}\label{eqn:convert-smalldt}
w_{ij}=\ln\left(1+\frac{v_{E}/V_{b}}{r_i\tau_w}\right).
\end{equation}

Inhibitory connections were also drawn from exponential distribution with the negative mean. Inhibitory connections strength was chosen so as to balance excitatory and inhibitory currents in the network and achieve dynamic firing rate $\langle \lambda_i(t) \rangle$ close to the base firing rate $\langle r_i\rangle \approx 5 $ Hz. Practically, the mean strength of inhibitory connections was about 10 times larger than that of the excitatory connections. 

The time course of functional connectivity weights $w_{ij}(t)$ was modeled as the difference of two exponentials with the rise time of 1 ms and decay time of 10 ms for excitatory and 20 ms for inhibitory currents \cite{Sayer1990}. Up to 25\% variation in these time constants could be allowed. We neglected conduction delays, given that the time delay below $\sim 1$ ms expected in local cortical circuit was smaller than the time step of our computer simulation.  Additionally to excitatory and inhibitory currents, each neuron was modeled to have refractory current with the time-course described as an exponential with time-constant of 10 ms.

Spike-trains were generated using GLM by simulating network forward in time with the time step of 1 ms.  Given the spike rasters, the fluorescence observations were generated using calcium dynamics model Eq.\eqref{eqn:ca:definition}). Parameters for the model were chosen according to our experience with few actual cells analyzed using algorithm of \cite{Vogelstein2009}, see Table \ref{table:caparm}.  The population of cells was generated with these parameters allowing cell-to-cell variance of at least 30\%.  Fluorescence was obtained for calcium imaging at the frame-rate of 33Hz or 66Hz.  From 300 s to 3600 s of calcium imaging data was simulated.

\begin{table}[h!b!p!]
\caption{Table of simulation parameters.}\label{table:caparm}
\begin{tabular}{ll}
\hline
Total neurons & 10-500 \\
Inhibitory neurons & 20\% \\
Connections sparseness & 10\% \\
Baseline firing rate & 5 Hz \\
Mean EPSP strength & 0.5 $\mu$V \\
Mean IPSP strength & 2.3 $\mu$V\\
EPSP profile & 1 ms rise, 10 ms exp falloff \\
IPSP profile & 1 ms rise, 20 ms exp falloff \\
\hline
Mean Ca noise $\sigma_c$ & 28 $\mu$M \\
Mean Ca jump $A_c$ & 80 $\mu$M \\
Mean Ca background $C_b$ & 24 $\mu$M \\
Mean Ca decay time $\tau_c$ & 0.25 s \\
Mean photon budget $\alpha_c$ & 1-80 Kph/neuron/frame \\
$K_d$ & 200 $\mu$M \\
\hline
\end{tabular}
\end{table}

\begin{figure}
\centering
\begin{minipage}[c]{0.45\hsize}
includegraphics[width=250pt]{../figs/Figure0b_fluor_eg_hlowSNR}
\includegraphics{../figs/Figure0b_fluor_eg_hlowSNR}
\end{minipage}
\begin{minipage}[c]{0.45\hsize}
\includegraphics[width=250pt]{../figs/Figure0a_fluor_eg_highSNR}
\end{minipage}
\caption{Examples of calcium and fluorescence traces for low (photon budget 5 Kph/neuron/frame, left)
and high SNR regimes (photon budget 40 Kph/neuron/frame, right).}
\label{fig:egfluor}
\end{figure}